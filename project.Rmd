---
title: Analiza skupa podataka o kretanju taksi vozila u Njujorku u januaru 2015. godine
author: Luka Ćirić
output: html_document
---

### Luka Ćirić, E2 18/2023
# Specifikacija
Specifikacija na [linku](http://www.acs.uns.ac.rs/sr/filebrowser/download/11975528)

# Opis skupa podataka
Skup podataka je javno dostupan za preuzimanje na [linku](https://www.nyc.gov/site/tlc/about/tlc-trip-record-data.page). 
Podaci originalno preuzeti u **PARQUET** formatu, a zatim konvertovani u **CSV** format.
Skup podataka se sastoji od podataka o kretanju taksi vozila i zaradi u Njujorku u januaru 2015. godine.

## Opis atributa
Skup podataka se sastoji od atributa:
- **VendorID** - identifikator provajdera usluge taksi prevoza
- **tpep_pickup_datetime** - datum i vreme preuzimanja putnika
- **tpep_dropoff_datetime** - datum i vreme iskrcavanja putnika
- **passenger_count** - broj putnika
- **trip_distance** - dužina putovanja u miljama
- **RatecodeID** - identifikator tarifnog koda
- **store_and_fwd_flag** - indikator da li je vožnja prvo sačuvana u memoriji pre slanja
- **PULocationID** - identifikator lokacije preuzimanja putnika
- **DOLocationID** - identifikator lokacije iskrcavanja putnika
- **payment_type** - način plaćanja
- **fare_amount** - cena vožnje
- **extra** - dodatni troškovi
- **mta_tax** - troškovi MTA
- **tip_amount** - napojnica (popunjena samo za plaćanje karticom)
- **tolls_amount** - troškovi putarine
- **improvement_surcharge** - troškovi poboljšanja
- **total_amount** - ukupna cena
- **congestion_surcharge** - troškovi gužve
- **airport_fee** - troškovi aerodroma

Specifikacija obeležja dostupna na [linku](https://www.nyc.gov/assets/tlc/downloads/pdf/data_dictionary_trip_records_yellow.pdf)

## Kod za prevođenje podataka u CSV format (Python):
```python
import pandas as pd

def parquet_to_csv(parquet_file_path, csv_file_path):
    # Read the Parquet file into a DataFrame
    df = pd.read_parquet(parquet_file_path)
    
    # Write the DataFrame to a CSV file
    df.to_csv(csv_file_path, index=False)

if __name__ == "__main__":
    # Replace these with your actual file paths
    parquet_file_path = input("Enter input file: ") + ".parquet"
    csv_file_path = input("Enter output file: ") + ".csv"
    
    parquet_to_csv(parquet_file_path, csv_file_path)
    print(f"Parquet file '{parquet_file_path}' has been converted to CSV file '{csv_file_path}'.")
```

# Implementacija
## Instalacija paketa
```{r Instalacija paketa, eval=TRUE, include=TRUE}
install.packages("tidyverse")
install.packages("sparklyr")
install.packages("rmarkdown")
install.packages("knitr")
install.packages("pandoc")
```
## Učitavanje paketa
```{r Učitavanje paketa, eval=TRUE, include=TRUE}
library(sparklyr)
library(dplyr)
library(knitr)
library(rmarkdown)
library(ggplot2)
library(pandoc)
spark_install()
knitr::opts_knit$set(root.dir = file.path(getwd()))
```
## Podešavanje Spark sesije
```{r Podešavanje Spark sesije i knitr, eval=TRUE, include=TRUE}
conf <- spark_config()
conf["spark.executor.memory"] <- "6G"
conf["sparklyr.shell.driver-memory"] <- "6G"
sc <- spark_connect(master = "local", config = conf)
```
## Podešavanje working direktorijuma
```{r Podešavanje working direktorijuma, eval=TRUE, include=TRUE}
setwd("~/FAX/RVPUII/projekat")
```

## Učitavanje skupa podataka
```{r Učitavanje skupa podataka, eval=TRUE, include=TRUE}
ds.path <- "~/FAX/RVPUII/projekat/data"
ds.df <- spark_read_csv(sc, name = "my_data", path = ds.path, header = TRUE, infer_schema = TRUE, memory = TRUE)
```

## Filtriranje skupa podataka
```{r Filtriranje skupa podataka, eval=TRUE, include=TRUE}
ds.filtered <- ds.df %>% 
    select(-store_and_fwd_flag, -airport_fee, -congestion_surcharge) %>%
    filter(
      !is.na(VendorID) || !is.na(tpep_pickup_datetime) || !is.na(tpep_dropoff_datetime) || !is.na(passenger_count) || 
      !is.na(trip_distance) || !is.na(RatecodeID) || !is.na(PULocationID) || !is.na(DOLocationID) ||
      !is.na(payment_type) || !is.na(fare_amount) || !is.na(extra) || !is.na(mta_tax) || !is.na(tip_amount) || 
      !is.na(tolls_amount) || !is.na(improvement_surcharge) || !is.na(total_amount)
    ) %>%
    filter(
        trip_distance < 200 && trip_distance > 0
    )
```

## Dodavanje novih atributa
```{r Dodavanje novih atributa, eval=TRUE, include=TRUE}
data <- ds.filtered %>% 
    mutate(payed_with_card = ifelse(payment_type == 1, T, F))
```

## Analiza pojedinačnih atributa
### Analiza atributa VendorID
```{r Analiza atributa VendorID, eval=TRUE, include=TRUE}
vendorIdCounts <- data %>%
    group_by(VendorID) %>% 
    summarise(count = n()) %>% 
    collect()

print("Broj vožnji po VendorID-u")
kable(vendorIdCounts)

bar <- ggplot(vendorIdCounts, aes(x = VendorID, y = count, fill = VendorID)) +
    geom_bar(stat = "identity") +
    labs(title = "Broj vožnji po VendorID-u", x = "VendorID", y = "Broj vožnji") +
    scale_y_continuous(breaks = seq(0, 10000000, 1000000))
    theme_minimal()

ggsave("images/vendorIdCounts.png", bar)
```
![Broj vožnji po VendorID-u](images/vendorIdCounts.png)
### Analiza atributa passenger_count
```{r Analiza atributa passenger_count, eval=TRUE, include=TRUE}
passengerCountCounts <- data %>%
    group_by(passenger_count) %>% 
    summarise(count = n()) %>% 
    collect()

print("Broj vožnji po broju putnika")
kable(passengerCountCounts)

passengerCounts <- pull(data, passenger_count)

png("images/passengerCountHistogram.png", width = 800, height = 1200)
xgran <- pretty(passengerCounts, n = 10)
xlabel <- seq(1, 8, 1)
hst <- hist(passengerCounts, main = "Broj vožnji po broju putnika", xlab = "Broj putnika", ylab = "Broj vožnji")
axis(1, at = xlabel, labels = xlabel)
ygran <- pretty(hst$counts, n = 10)
ylabel <- replace(ygran, ygran %% 1000000 != 0, NA)
axis(2, at = ygran, labels = ylabel)

dev.off()
```
![Broj vožnji po broju putnika](images/passengerCountHistogram.png)

### Analiza atributa trip_distance
```{r Analiza atributa trip_distance, eval=TRUE, include=TRUE}
tripDistanceCounts <- data %>%
    summarise(min = min(trip_distance), max = max(trip_distance), avg = mean(trip_distance), median = median(trip_distance)) %>%
    collect()

print("Statistika atributa trip_distance")
kable(tripDistanceCounts)

tripDistances <- pull(data, trip_distance)
plt <- plot(density(tripDistances), main = "Distribucija atributa trip_distance", xlab = "Dužina putovanja", ylab = "Gustina")
ggsave("images/tripDistanceDensity.png", plt)
```


